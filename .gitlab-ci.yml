---
image: hashicorp/terraform:latest

# NOTE - New accounts must be initialized outside of GitLab CI/CD
# to setup the S3 state bucket and DynamoDB lock table.
# See bin/aws_init

variables:
  # Remianing items should be defined in project variables
  AWS_ACCESS_KEY_ID: setme
  AWS_SECRET_ACCESS_KEY: setme
  AWS_ACOUNT_ID: setme
  AWS_DEFAULT_REGION: setme
  TF_VAR_infra_name: setme
  TF_VAR_root_zone: setme
  TF_VAR_static_site_fqdn: setme
  TF_VAR_static_dns_record_file: setme_as_file

stages:
  - check_fmt
  - account_tfsec
  - account_plan
  - account_apply
  - web_tfsec
  - web_plan
  - web_apply

before_script:
  # Default setup for most stages
  - mkdir -p plans
  - . bin/commonlib
  - init_tf_vars $TF_VAR_infra_name $CI_ENVIRONMENT_NAME
  - cd stacks/$CI_ENVIRONMENT_NAME
  - terraform init
    -backend-config="bucket=${TF_VAR_state_bucket}"
    -backend-config="key=${TF_VAR_stack_name}"
    -backend-config="dynamodb_table=${TF_VAR_lock_table}"
    -backend-config="region=${TF_VAR_region}"

# Universal stages
check_fmt:
  stage: check_fmt
  before_script: []
  script:
    - terraform fmt -recursive -diff -check

# Templates
.tfsec:
  image: tfsec/tfsec-ci
  before_script:
    - . bin/commonlib
    - init_tf_vars $TF_VAR_infra_name $CI_ENVIRONMENT_NAME
  script:
    - tfsec stacks/$CI_ENVIRONMENT_NAME
  needs:
    - job: check_fmt

.plan:
  script:
    - terraform plan -detailed-exitcode
      -out ${CI_PROJECT_DIR}/plans/${CI_ENVIRONMENT_NAME}.plan
      || exit_code=$?
    - case $exit_code in
        0) echo "CHANGED=false" >> plan.env;;
        1) exit 1;;
        2) echo "CHANGED=true" >> plan.env;;
      esac  
  needs:
    - job: ${CI_ENVIRONMENT_NAME}_tfsec
  artifacts:
    paths:
      - plans
      - stacks/${CI_ENVIRONMENT_NAME}/.terraform
    reports:
      dotenv: plan.env

.apply:
  script:
    - terraform apply -auto-approve
      ${CI_PROJECT_DIR}/plans/${CI_ENVIRONMENT_NAME}.plan
  needs:
    - job: ${CI_ENVIRONMENT_NAME}_plan
      artifacts: true
  only:
    variables:
      - $CHANGED == "true"
    
# Prod account level resources
account:tfsec:
  extends: .tfsec
  environment: account
  stage: account_tfsec

account:plan:
  extends: .plan
  environment: account
  stage: account_plan

account:apply:
  extends: .apply
  environment: account
  stage: account_apply
  when: manual
  only:
    - main

# Static web site
web:tfsec:
  extends: .tfsec
  environment: web
  stage: web_tfsec

web:plan:
  extends: .plan
  environment: web
  stage: web_plan

web:apply:
  extends: .apply
  environment: web
  stage: web_apply
  only:
    - main
